# Управление нодами

## Добавление новой ноды

### Через веб-интерфейс:
1. Перейдите в раздел "Ноды"
2. Нажмите "Добавить ноду"
3. Заполните информацию о ноде:
   - Название ноды
   - IP-адрес или домен
   - Порт для API
   - Ключ аутентификации
   - Регион размещения
   - Максимальная нагрузка (пользователи)
   - Статус (активна/неактивна)
4. Нажмите "Сохранить"

### Через API:
```http
POST /api/v1/nodes/
Content-Type: application/json
Authorization: Bearer <ваш_токен>

{
  "name": "EU-Frankfurt-1",
  "host": "vpn-eu1.example.com",
  "port": 8443,
  "api_key": "secure-api-key-123",
  "location": "eu-central-1",
  "max_users": 1000,
  "is_active": true
}
```

## Настройка ноды

### Обязательные настройки:
1. **Xray-core**: Установите и настройте Xray-core на сервере
2. **API доступ**: Настройте доступ к API ноды
3. **Брандмауэр**: Откройте необходимые порты
4. **Мониторинг**: Настройте сбор метрик

### Пример настройки Xray:
```json
{
  "api": {
    "tag": "api",
    "services": ["HandlerService", "StatsService"]
  },
  "policy": {
    "levels": {
      "0": {
        "handshake": 4,
        "connIdle": 300,
        "uplinkOnly": 1,
        "downlinkOnly": 1
      }
    }
  },
  "stats": {},
  "log": {
    "loglevel": "warning"
  }
}
```

## Мониторинг нод

### Доступные метрики:
- Загрузка CPU
- Использование оперативной памяти
- Сетевой трафик (входящий/исходящий)
- Количество активных подключений
- Использование диска

### Настройка оповещений:
1. Перейдите в настройки мониторинга
2. Настройте пороговые значения для уведомлений
3. Укажите email для оповещений

## Балансировка нагрузки

### Настройки балансировки:
- Распределение по геолокации
- Равномерное распределение пользователей
- Балансировка по загрузке

### Пример настройки балансировки:
```yaml
load_balancing:
  strategy: round_robin  # или least_connections, ip_hash
  health_check:
    interval: 30s
    timeout: 5s
    unhealthy_threshold: 3
    healthy_threshold: 2
```

## Обновление нод

### Процесс обновления:
1. Создайте резервную копию конфигурации
2. Обновите Xray-core до последней версии
3. Примените изменения конфигурации
4. Перезапустите сервис
5. Проверьте работоспособность

### Автоматическое обновление:
```bash
# Добавьте в cron для автоматического обновления
0 3 * * * /usr/local/bin/update-xray.sh
```

## Устранение неполадок

### Частые проблемы:
1. **Нода недоступна**
   - Проверьте сетевое соединение
   - Убедитесь, что порты открыты
   - Проверьте статус сервиса Xray

2. **Высокая загрузка CPU**
   - Проверьте количество подключений
   - Проанализируйте логи на наличие ошибок
   - Рассмотрите возможность масштабирования

3. **Проблемы с аутентификацией**
   - Проверьте API ключ
   - Убедитесь в правильности настроек доступа
   - Проверьте срок действия сертификатов

## Резервное копирование конфигурации

### Рекомендуемый процесс:
1. Ежедневное полное резервное копирование
2. Инкрементальное копирование каждый час
3. Хранение резервных копий не менее 30 дней

### Пример скрипта резервного копирования:
```bash
#!/bin/bash
BACKUP_DIR="/var/backups/xray-config"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR
cp /usr/local/etc/xray/config.json "$BACKUP_DIR/config_$DATE.json"
find $BACKUP_DIR -type f -mtime +30 -delete
```

## Безопасность

### Рекомендации:
1. Используйте только HTTPS для API
2. Ограничьте доступ к API по IP
3. Регулярно обновляйте Xray-core
4. Настройте мониторинг подозрительной активности
5. Используйте сложные API ключи

## Интеграция с системой мониторинга

### Поддерживаемые системы:
- Prometheus
- Grafana
- Zabbix
- Nagios

### Пример настройки экспортера метрик:
```yaml
metrics:
  enabled: true
  port: 9090
  path: /metrics
  auth:
    enabled: true
    username: metrics
    password: secure-password-123
```
